import React, { useState, useEffect, useRef, createContext, useContext } from 'react';
import { BrowserRouter as Router, Routes, Route, Link, Outlet, useNavigate, useLocation } from 'react-router-dom';
import { create } from 'zustand';
import { persist, devtools } from 'zustand/middleware';

// --- Utility Functions ---

// Function to generate unique IDs
const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

// Function to format currency
const formatCurrency = (amount: number) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);

// Function to format date
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
};

// --- Type Definitions (types.ts) ---

interface Product {
  id: string;
  name: string;
  sku: string;
  description?: string;
  purchasePrice: number;
  sellingPrice: number;
  stock: number;
  reorderLevel: number;
}

interface Customer {
  id: string;
  name: string;
  contact: string;
  address?: string;
  email?: string;
}

interface SaleItem {
  productId: string;
  productName: string;
  sku: string;
  quantity: number;
  price: number; // Selling price at the time of sale
  total: number;
}

interface Sale {
  id: string;
  date: string; // ISO string
  customerId?: string;
  customerName?: string;
  items: SaleItem[];
  subtotal: number;
  discount: number;
  totalAmount: number;
  amountPaid: number;
  paymentMethod: 'Cash' | 'Card' | 'UPI' | 'Credit';
  changeDue: number; // If cash payment > totalAmountPaid
  isCreditSale: boolean;
  status: 'Completed' | 'Refunded';
}

interface KhataEntry {
  id: string;
  customerId: string;
  customerName: string;
  date: string; // ISO string
  type: 'Credit' | 'Payment';
  amount: number;
  saleId?: string; // Link to sale if credit is from a sale
  notes?: string;
}

// --- Zustand Store (store/useStore.ts) ---

interface ProductSlice {
  products: Product[];
  addProduct: (product: Omit<Product, 'id'>) => void;
  updateProduct: (id: string, product: Partial<Omit<Product, 'id'>>) => void;
  deleteProduct: (id: string) => void;
  decreaseProductStock: (productId: string, quantity: number) => void;
  increaseProductStock: (productId: string, quantity: number) => void;
}

interface CustomerSlice {
  customers: Customer[];
  addCustomer: (customer: Omit<Customer, 'id'>) => void;
  updateCustomer: (id: string, customer: Partial<Omit<Customer, 'id'>>) => void;
  deleteCustomer: (id: string) => void;
}

interface SaleSlice {
  sales: Sale[];
  addSale: (sale: Sale) => void;
}

interface KhataSlice {
  khataEntries: KhataEntry[];
  addKhataEntry: (entry: Omit<KhataEntry, 'id'>) => void;
  getCustomerCreditBalance: (customerId: string) => number;
}

interface StockDeskState extends ProductSlice, CustomerSlice, SaleSlice, KhataSlice {}

export const useStore = create<StockDeskState>()(
  devtools(
    persist(
      (set, get) => ({
        // Initial State
        products: [],
        customers: [],
        sales: [],
        khataEntries: [],

        // Product Actions
        addProduct: (product) => set((state) => ({
          products: [...state.products, { ...product, id: generateId() }],
        })),
        updateProduct: (id, updatedFields) => set((state) => ({
          products: state.products.map((p) => p.id === id ? { ...p, ...updatedFields } : p),
        })),
        deleteProduct: (id) => set((state) => ({
          products: state.products.filter((p) => p.id !== id),
        })),
        decreaseProductStock: (productId, quantity) => set((state) => ({
          products: state.products.map((p) =>
            p.id === productId ? { ...p, stock: p.stock - quantity } : p
          ),
        })),
        increaseProductStock: (productId, quantity) => set((state) => ({
          products: state.products.map((p) =>
            p.id === productId ? { ...p, stock: p.stock + quantity } : p
          ),
        })),

        // Customer Actions
        addCustomer: (customer) => set((state) => ({
          customers: [...state.customers, { ...customer, id: generateId() }],
        })),
        updateCustomer: (id, updatedFields) => set((state) => ({
          customers: state.customers.map((c) => c.id === id ? { ...c, ...updatedFields } : c),
        })),
        deleteCustomer: (id) => set((state) => ({
          customers: state.customers.filter((c) => c.id !== id),
        })),

        // Sale Actions
        addSale: (sale) => {
          set((state) => ({
            sales: [...state.sales, sale],
          }));

          // Decrease product stock for each item in the sale
          sale.items.forEach(item => {
            get().decreaseProductStock(item.productId, item.quantity);
          });

          // Add khata entry if it's a credit sale
          if (sale.isCreditSale && sale.customerId) {
            get().addKhataEntry({
              customerId: sale.customerId,
              customerName: sale.customerName || 'Unknown Customer',
              date: sale.date,
              type: 'Credit',
              amount: sale.totalAmount - sale.amountPaid, // Outstanding credit
              saleId: sale.id,
              notes: `Credit for Sale #${sale.id.slice(-6)}`,
            });
          }
        },

        // Khata Actions
        addKhataEntry: (entry) => set((state) => ({
          khataEntries: [...state.khataEntries, { ...entry, id: generateId() }],
        })),
        getCustomerCreditBalance: (customerId) => {
          const entries = get().khataEntries.filter(entry => entry.customerId === customerId);
          const totalCredit = entries.filter(e => e.type === 'Credit').reduce((sum, e) => sum + e.amount, 0);
          const totalPayments = entries.filter(e => e.type === 'Payment').reduce((sum, e) => sum + e.amount, 0);
          return totalCredit - totalPayments;
        },
      }),
      {
        name: 'stock-desk-storage', // name of the item in localStorage
        version: 1,
      }
    )
  )
);


// --- UI Components (components/ui/...) ---

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'outline';
  size?: 'sm' | 'md' | 'lg';
}

const Button: React.FC<ButtonProps> = ({ children, variant = 'primary', size = 'md', className, ...props }) => {
  const baseStyles = 'font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200';
  const variantStyles = {
    primary: 'bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500',
    secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-500',
    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
    outline: 'border border-gray-300 text-gray-700 hover:bg-gray-50 focus:ring-gray-500'
  };
  const sizeStyles = {
    sm: 'px-3 py-1 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-5 py-3 text-lg',
  };

  return (
    <button
      className={`${baseStyles} ${variantStyles[variant]} ${sizeStyles[size]} ${className || ''}`}
      {...props}
    >
      {children}
    </button>
  );
};

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
}

const Input: React.FC<InputProps> = ({ label, error, className, id, ...props }) => {
  const inputId = id || generateId();
  return (
    <div className="mb-4">
      {label && (
        <label htmlFor={inputId} className="block text-sm font-medium text-gray-700 mb-1">
          {label}
        </label>
      )}
      <input
        id={inputId}
        className={`block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm ${className || ''} ${error ? 'border-red-500' : ''}`}
        {...props}
      />
      {error && <p className="mt-1 text-sm text-red-600">{error}</p>}
    </div>
  );
};

interface SelectProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
  label?: string;
  error?: string;
  options: { value: string; label: string; }[];
}

const Select: React.FC<SelectProps> = ({ label, error, className, id, options, ...props }) => {
  const selectId = id || generateId();
  return (
    <div className="mb-4">
      {label && (
        <label htmlFor={selectId} className="block text-sm font-medium text-gray-700 mb-1">
          {label}
        </label>
      )}
      <select
        id={selectId}
        className={`block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm ${className || ''} ${error ? 'border-red-500' : ''}`}
        {...props}
      >
        {options.map(option => (
          <option key={option.value} value={option.value}>
            {option.label}
          </option>
        ))}
      </select>
      {error && <p className="mt-1 text-sm text-red-600">{error}</p>}
    </div>
  );
};

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  footer?: React.ReactNode;
}

const Modal: React.FC<ModalProps> = ({ isOpen, onClose, title, children, footer }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div className="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        {/* Overlay */}
        <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

        {/* This element is to trick the browser into centering the modal contents. */}
        <span className="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div className="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
          <div className="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div className="sm:flex sm:items-start">
              <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                <h3 className="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                  {title}
                </h3>
                <div className="mt-2">
                  {children}
                </div>
              </div>
            </div>
          </div>
          <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            {footer || (
              <Button type="button" variant="secondary" onClick={onClose}>Close</Button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

interface TableProps<T> {
  data: T[];
  columns: { key: keyof T | 'actions'; header: string; render?: (item: T) => React.ReactNode; }[];
}

const Table = <T extends { id?: string }>({ data, columns }: TableProps<T>) => {
  return (
    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          <tr>
            {columns.map((col, idx) => (
              <th
                key={idx}
                scope="col"
                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                {col.header}
              </th>
            ))}
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {data.length === 0 ? (
            <tr>
              <td colSpan={columns.length} className="px-6 py-4 text-center text-gray-500">
                No data available.
              </td>
            </tr>
          ) : (
            data.map((item) => (
              <tr key={item.id || generateId()}>
                {columns.map((col, idx) => (
                  <td key={idx} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {col.render ? col.render(item) : (item[col.key] as React.ReactNode)}
                  </td>
                ))}
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );
};

interface AlertProps {
  message: string;
  type: 'success' | 'error' | 'info' | 'warning';
  onClose?: () => void;
}

const Alert: React.FC<AlertProps> = ({ message, type, onClose }) => {
  const [isVisible, setIsVisible] = useState(true);

  useEffect(() => {
    if (isVisible) {
      const timer = setTimeout(() => {
        setIsVisible(false);
        if (onClose) onClose();
      }, 5000);
      return () => clearTimeout(timer);
    }
  }, [isVisible, onClose]);

  if (!isVisible) return null;

  const styles = {
    success: 'bg-green-100 border-green-400 text-green-700',
    error: 'bg-red-100 border-red-400 text-red-700',
    info: 'bg-blue-100 border-blue-400 text-blue-700',
    warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
  };

  return (
    <div className={`p-3 border rounded-md flex justify-between items-center ${styles[type]}`}>
      <p className="text-sm font-medium">{message}</p>
      <button onClick={() => setIsVisible(false)} className="ml-auto text-current hover:text-opacity-75">
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
        </svg>
      </button>
    </div>
  );
};

// --- Layout Components (components/Layout.tsx, components/Sidebar.tsx) ---

interface NavLinkProps {
  to: string;
  icon: React.ReactNode;
  label: string;
}

const SidebarNavLink: React.FC<NavLinkProps> = ({ to, icon, label }) => {
  const location = useLocation();
  const isActive = location.pathname === to;
  const activeClasses = 'bg-indigo-700 text-white';
  const inactiveClasses = 'text-indigo-200 hover:bg-indigo-600 hover:text-white';

  return (
    <Link
      to={to}
      className={`group flex items-center px-2 py-2 text-base font-medium rounded-md ${isActive ? activeClasses : inactiveClasses}`}
    >
      {icon}
      {label}
    </Link>
  );
};

const Layout: React.FC = () => {
  return (
    <div className="h-screen flex bg-gray-100">
      {/* Sidebar */}
      <div className="flex flex-col w-64 bg-indigo-800 text-white shadow-xl">
        <div className="flex items-center justify-center h-16 bg-indigo-900">
          <span className="text-2xl font-bold">Stock Desk</span>
        </div>
        <nav className="flex-1 px-2 py-4 space-y-2">
          <SidebarNavLink to="/" label="Dashboard" icon={<svg className="mr-4 flex-shrink-0 h-6 w-6 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>}
          />
          <SidebarNavLink to="/products" label="Products" icon={<svg className="mr-4 flex-shrink-0 h-6 w-6 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>}
          />
          <SidebarNavLink to="/sales/new" label="New Sale" icon={<svg className="mr-4 flex-shrink-0 h-6 w-6 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>}
          />
          <SidebarNavLink to="/sales" label="Sales History" icon={<svg className="mr-4 flex-shrink-0 h-6 w-6 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>}
          />
          <SidebarNavLink to="/customers" label="Customers" icon={<svg className="mr-4 flex-shrink-0 h-6 w-6 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.192-1.294-.543-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.192-1.294.543-1.857m0 0a2.502 2.502 0 01-2.502-2.5V7a2.5 2.502 0 012.502-2.5h10.496a2.502 2.502 0 012.502 2.5v7.5a2.502 2.502 0 01-2.502 2.5M10 9a2 2 0 114 0 2 2 0 01-4 0zm-4 7a2 2 0 114 0 2 2 0 01-4 0z" /></svg>}
          />
          <SidebarNavLink to="/khata" label="Customer Credit" icon={<svg className="mr-4 flex-shrink-0 h-6 w-6 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 8h6m-5 0v3m-3-3h.01M9 12H7a2 2 0 00-2 2v4h12v-4a2 2 0 00-2-2h-2M15 12H9l1-2 3 2 4-2 3 2 1-2V2a1 1 0 00-1-1H3a1 1 0